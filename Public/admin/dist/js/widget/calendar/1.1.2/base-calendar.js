/*! zuboke 2015-01-26 */
var $=require("jquery"),Position=require("position"),moment=require("moment"),Widget=require("arale-widget"),Shim=require("arale-iframe-shim"),langs={"zh-cn":require("./i18n/zh-cn"),"zh-tw":require("./i18n/zh-tw"),fr:require("./i18n/fr"),ja:require("./i18n/ja"),en:require("./i18n/en")},ua=(window.navigator.userAgent||"").toLowerCase(),match=ua.match(/msie\s+(\d+)/),insaneIE=!1;match&&match[1]&&(insaneIE=parseInt(match[1],10)<9),document.documentMode&&document.documentMode<9&&(insaneIE=!0);var current_date=moment();current_date=moment([current_date.year(),current_date.month(),current_date.date()]);var BaseCalendar=Widget.extend({attrs:{lang:"zh-cn",trigger:null,triggerType:"click",output:{value:"",getter:function(a){return a=a?a:this.get("trigger"),$(a)}},hideOnSelect:!0,focus:{value:"",getter:function(a){return a=a||this._outputTime(),a?moment(a,this.get("format")):current_date},setter:function(a){return a?moment(a,this.get("format")):current_date}},format:"YYYY-MM-DD",startDay:"Sun",range:{value:null,setter:function(a){if($.isArray(a)){var b=this.get("format"),c=[];return $.each(a,function(a,d){d=null===d?null:moment(d,b),c.push(d)}),c}return a}},process:null,align:{getter:function(a){if(a)return a;var b=$(this.get("trigger"));return b?{selfXY:[0,0],baseElement:b,baseXY:[0,"100%"]}:{selfXY:[0,0],baseXY:[0,0]}}}},setup:function(){BaseCalendar.superclass.setup.call(this),this.enable(),"string"==typeof this.get("lang")&&this.set("lang",langs[this.get("lang")]),this._shim=new Shim(this.element);var a=this;this.element.on("mousedown",function(b){if(insaneIE){var c=$(a.get("trigger"))[0];c.onbeforedeactivate=function(){window.event.returnValue=!1,c.onbeforedeactivate=null}}b.preventDefault()})},show:function(){this.trigger("show"),this.rendered||(this._pin(),this.render()),this._pin(),this.element.show()},hide:function(){this.trigger("hide"),this.element.hide()},_pin:function(a){a=a||this.get("align"),Position.pin({element:this.element,x:a.selfXY[0],y:a.selfXY[1]},{element:a.baseElement,x:a.baseXY[0],y:a.baseXY[1]})},_outputTime:function(){var a=$(this.get("output")),b=a.val()||a.text();return b&&(b=moment(b,this.get("format")),b.isValid())?b:void 0},output:function(a){var b=this.get("output");if(b.length){a=a||this.get("focus");var c=b[0].tagName.toLowerCase();"input"===c||"textarea"===c?b.val(a):b.text(a),this.get("hideOnSelect")&&this.hide()}},enable:function(){var a=this.get("trigger");if(a){var b=this,c=$(a);if("date"===c.attr("type"))try{c.attr("type","text")}catch(d){}var e=this.get("triggerType")+".calendar";c.on(e,function(){b.show(),b._shim.sync()}),c.on("blur.calendar",function(){b.hide(),b._shim.sync()}),"input"!==c[0].tagName.toLowerCase()&&b.autohide()}},disable:function(){var a=this.get("trigger");if(a){var b=$(a),c=this.get("triggerType")+".calendar";b.off(c),b.off("blur.calendar")}},autohide:function(){var a=this,b=$(this.get("trigger"))[0],c=this.element;$("body").on("mousedown.calendar",function(d){c.find(d.target).length||c[0]===d.target||b!==d.target&&a.hide()})},destroy:function(){this._shim&&this._shim.destroy(),$("body").off("mousedown.calendar"),BaseCalendar.superclass.destroy.call(this)}});module.exports=BaseCalendar;